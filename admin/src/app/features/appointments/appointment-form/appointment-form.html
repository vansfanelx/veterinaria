<div class="appointment-form-page">
  <div class="page-header">
    <div class="header-content">
      <h1>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
        </svg>
        {{ isEditMode ? 'Editar Cita' : 'Nueva Cita' }}
      </h1>
      <a routerLink="/appointments" class="btn-back">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
        Volver
      </a>
    </div>
    @if (error) {
      <div class="alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
        </svg>
        {{ error }}
      </div>
    }
  </div>

  <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()" class="appointment-form">
    <!-- Secci√≥n de Mascota y Due√±o -->
    <div class="form-section">
      <div class="section-header">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M4.5 9.5m-2.5 0a2.5 2.5 0 1 0 5 0a2.5 2.5 0 1 0 -5 0M19.5 9.5m-2.5 0a2.5 2.5 0 1 0 5 0a2.5 2.5 0 1 0 -5 0M9 9.5m-2.5 0a2.5 2.5 0 1 0 5 0a2.5 2.5 0 1 0 -5 0M15 9.5m-2.5 0a2.5 2.5 0 1 0 5 0a2.5 2.5 0 1 0 -5 0M12 16a3 3 0 0 1 3 3a3 3 0 0 1 -3 3a3 3 0 0 1 -3 -3a3 3 0 0 1 3 -3"/>
        </svg>
        <h2>Informaci√≥n de la Mascota</h2>
      </div>

      <div class="form-group-modern">
        <label for="pet_search">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
          </svg>
          Buscar Mascota *
        </label>
        <div class="search-wrapper">
          <input 
            type="text" 
            id="pet_search"
            [(ngModel)]="petSearchTerm"
            [ngModelOptions]="{standalone: true}"
            (focus)="showPetDropdown = true"
            (input)="filterPets()"
            class="form-control-modern"
            placeholder="Buscar por nombre, especie o due√±o..."
            [class.has-selection]="selectedPet"
          >
          @if (selectedPet) {
            <button type="button" class="clear-btn" (click)="clearPetSelection()" title="Limpiar selecci√≥n">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
              </svg>
            </button>
          }
          @if (showPetDropdown && filteredPets.length > 0) {
            <div class="dropdown-list-modern">
              @for (pet of filteredPets; track pet.id) {
                <button type="button" class="dropdown-item-modern" (click)="selectPet(pet)">
                  <div class="pet-avatar">
                    {{ pet.species === 'Perro' ? 'üêï' : pet.species === 'Gato' ? 'üêà' : 'üêæ' }}
                  </div>
                  <div class="pet-info-modern">
                    <strong>{{ pet.name }}</strong>
                    <span class="pet-meta">{{ pet.species }}{{ pet.breed ? ' ‚Ä¢ ' + pet.breed : '' }}</span>
                    <span class="owner-tag">üë§ {{ pet.owner?.name || 'Sin due√±o' }}</span>
                  </div>
                </button>
              }
            </div>
          }
        </div>
        @if (appointmentForm.get('pet_id')?.invalid && appointmentForm.get('pet_id')?.touched) {
          <div class="error-message-modern">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
            Debe seleccionar una mascota
          </div>
        }
      </div>
    </div>

    <!-- Secci√≥n de Fecha y Hora -->
    <div class="form-section">
      <div class="section-header">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
        </svg>
        <h2>Fecha y Horario</h2>
      </div>

      <div class="form-row-modern">
        <div class="form-group-modern">
          <label for="date">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
            </svg>
            Fecha de la Cita *
          </label>
          <input 
            type="date" 
            id="date" 
            formControlName="date" 
            class="form-control-modern"
          >
          @if (appointmentForm.get('date')?.invalid && appointmentForm.get('date')?.touched) {
            <div class="error-message-modern">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
              </svg>
              La fecha es requerida
            </div>
          }
        </div>

        <div class="form-group-modern">
          <label for="time">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
            </svg>
            Hora *
          </label>
          <input 
            type="time" 
            id="time" 
            formControlName="time" 
            class="form-control-modern"
          >
          @if (appointmentForm.get('time')?.invalid && appointmentForm.get('time')?.touched) {
            <div class="error-message-modern">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
              </svg>
              La hora es requerida
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Detalles -->
    <div class="form-section">
      <div class="section-header">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
        </svg>
        <h2>Detalles de la Consulta</h2>
      </div>

      <div class="form-group-modern">
        <label for="reason">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 9h-2V5h2v6zm0 4h-2v-2h2v2z"/>
          </svg>
          Motivo de la Consulta *
        </label>
        <textarea 
          id="reason" 
          formControlName="reason" 
          class="form-control-modern"
          rows="3"
          placeholder="Describe el motivo de la consulta..."
        ></textarea>
        @if (appointmentForm.get('reason')?.invalid && appointmentForm.get('reason')?.touched) {
          <div class="error-message-modern">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
            El motivo es requerido
          </div>
        }
      </div>

      <div class="form-row-modern">
        <div class="form-group-modern">
          <label for="status">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            Estado de la Cita *
          </label>
          <select id="status" formControlName="status" class="form-control-modern select-modern">
            <option value="pending">‚è≥ Pendiente</option>
            <option value="confirmed">‚úÖ Confirmada</option>
            <option value="completed">‚úîÔ∏è Completada</option>
            <option value="cancelled">‚ùå Cancelada</option>
          </select>
        </div>
      </div>

      <div class="form-group-modern">
        <label for="notes">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
          </svg>
          Observaciones Adicionales
        </label>
        <textarea 
          id="notes" 
          formControlName="notes" 
          class="form-control-modern"
          rows="4"
          placeholder="Informaci√≥n adicional relevante para la consulta..."
        ></textarea>
      </div>
    </div>

    <!-- Resumen y Acciones -->
    <div class="form-summary">
      <h3>Resumen de la Cita</h3>
      <div class="summary-grid">
        <div class="summary-item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4.5 9.5m-2.5 0a2.5 2.5 0 1 0 5 0a2.5 2.5 0 1 0 -5 0"/>
          </svg>
          <div>
            <span>Mascota:</span>
            <strong>{{ selectedPet?.name || 'No seleccionada' }}</strong>
          </div>
        </div>
        <div class="summary-item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
          </svg>
          <div>
            <span>Fecha:</span>
            <strong>{{ appointmentForm.get('date')?.value || 'No seleccionada' }}</strong>
          </div>
        </div>
        <div class="summary-item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
          </svg>
          <div>
            <span>Hora:</span>
            <strong>{{ appointmentForm.get('time')?.value || 'No seleccionada' }}</strong>
          </div>
        </div>
        <div class="summary-item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          <div>
            <span>Estado:</span>
            <strong>{{ getStatusLabel(appointmentForm.get('status')?.value) }}</strong>
          </div>
        </div>
      </div>
    </div>

    <div class="form-actions-modern">
      <button 
        type="submit" 
        [disabled]="appointmentForm.invalid || loading" 
        class="btn-submit"
      >
        @if (loading) {
          <div class="spinner-btn"></div>
          Guardando...
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
          {{ isEditMode ? 'Actualizar Cita' : 'Crear Cita' }}
        }
      </button>
      <a routerLink="/appointments" class="btn-cancel">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
        Cancelar
      </a>
    </div>
  </form>
</div>
