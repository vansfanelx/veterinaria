<div class="history-detail-container">
  @if (loading) {
    <div class="loading-overlay">
      <div class="spinner-medical">
        <div class="pulse"></div>
        <div class="heartbeat"></div>
      </div>
      <p class="loading-text">Cargando historial m茅dico...</p>
    </div>
  }

  @if (error) {
    <div class="alert alert-error">
      <span class="alert-icon">锔</span>
      <span>{{ error }}</span>
    </div>
  }

  @if (history && !loading) {
    <!-- Header principal estilo cl铆nica -->
    <div class="medical-header">
      <div class="header-background"></div>
      <div class="header-container">
        <div class="header-left">
          <div class="medical-icon-large">
            <div class="icon-circle">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
              </svg>
            </div>
          </div>
          <div class="header-text">
            <div class="header-badge">Historial M茅dico</div>
            <h1 class="header-title">Expediente #{{ history.id }}</h1>
            <div class="header-meta">
              <span class="meta-item">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                </svg>
                {{ history.visit_date | date:'dd MMMM yyyy' }}
              </span>
              <span class="meta-item">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                </svg>
                Dr. {{ history.veterinarian?.name || 'No especificado' }}
              </span>
            </div>
          </div>
        </div>
        <div class="header-actions">
          <a [routerLink]="['/medical-histories', history.id, 'edit']" class="action-btn edit-btn">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
            Editar
          </a>
          <button (click)="openDeleteModal()" class="action-btn delete-btn">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
            Eliminar
          </button>
          <a routerLink="/medical-histories" class="action-btn back-btn">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
            Volver
          </a>
        </div>
      </div>
    </div>

    <!-- Contenido principal en layout de 2 columnas -->
    <div class="medical-content">
      <!-- Columna izquierda -->
      <div class="content-main">
        <!-- Ficha del Paciente -->
        <div class="medical-card patient-profile">
          <div class="card-header-medical">
            <div class="header-icon-wrapper">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"/>
              </svg>
            </div>
            <h2>Informaci贸n del Paciente</h2>
          </div>
          <div class="card-content">
            <div class="patient-profile-content">
              <div class="patient-avatar-large">
                <div class="avatar-circle">
                  {{ history.pet?.species === 'Perro' ? '' : history.pet?.species === 'Gato' ? '' : history.pet?.species === 'Ave' ? '' : history.pet?.species === 'Conejo' ? '' : '' }}
                </div>
              </div>
              <div class="patient-info-section">
                <h3 class="patient-name">{{ history.pet?.name }}</h3>
                <div class="patient-tags">
                  <span class="tag tag-primary">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    {{ history.pet?.species }}
                  </span>
                  @if (history.pet?.breed) {
                    <span class="tag tag-secondary">
                      <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11z"/>
                      </svg>
                      {{ history.pet?.breed }}
                    </span>
                  }
                </div>
                <div class="patient-owner">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                  <div>
                    <span class="owner-label">Propietario</span>
                    <span class="owner-name">{{ history.pet?.owner?.name || 'No especificado' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Signos Vitales -->
        <div class="medical-card vitals-section">
          <div class="card-header-medical">
            <div class="header-icon-wrapper vitals-icon">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M13.5 4.06c0-1.11-.89-2-2-2s-2 .89-2 2v5.59H8.41L12 13.24l3.59-3.59H14.5V4.06zm6.5 2.12c0 1.3-.42 2.56-1.17 3.57-.75 1.01-1.83 1.77-3.07 2.14l.46 1.87c1.66-.43 3.06-1.43 4.03-2.8.97-1.37 1.5-3.02 1.5-4.78h-1.75zM12 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
              </svg>
            </div>
            <h2>Signos Vitales</h2>
          </div>
          <div class="card-content">
            <div class="vitals-grid-modern">
              <div class="vital-card weight-card">
                <div class="vital-icon-container">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/>
                  </svg>
                </div>
                <div class="vital-data">
                  <span class="vital-label">Peso</span>
                  <span class="vital-value">{{ history.weight || '--' }}</span>
                  <span class="vital-unit">kg</span>
                </div>
              </div>
              <div class="vital-card temp-card">
                <div class="vital-icon-container">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15 13V5c0-1.66-1.34-3-3-3S9 3.34 9 5v8c-1.21.91-2 2.37-2 4 0 2.76 2.24 5 5 5s5-2.24 5-5c0-1.63-.79-3.09-2-4zm-4-8c0-.55.45-1 1-1s1 .45 1 1h-1v1h1v2h-1v1h1v2h-2V5z"/>
                  </svg>
                </div>
                <div class="vital-data">
                  <span class="vital-label">Temperatura</span>
                  <span class="vital-value">{{ history.temperature || '--' }}</span>
                  <span class="vital-unit">掳C</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Diagn贸stico Principal -->
        <div class="medical-card diagnosis-section">
          <div class="card-header-medical">
            <div class="header-icon-wrapper diagnosis-icon">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm13.5-9l1.96 2.5H17V9h2.5zm-1.5 9c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
              </svg>
            </div>
            <h2>Diagn贸stico</h2>
          </div>
          <div class="card-content">
            <div class="diagnosis-banner">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              <span>{{ history.diagnosis }}</span>
            </div>
          </div>
        </div>

        <!-- S铆ntomas -->
        @if (history.symptoms) {
          <div class="medical-card symptoms-section">
            <div class="card-header-medical">
              <div class="header-icon-wrapper symptoms-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                </svg>
              </div>
              <h2>S铆ntomas Reportados</h2>
            </div>
            <div class="card-content">
              <div class="symptoms-content">
                <p>{{ history.symptoms }}</p>
              </div>
            </div>
          </div>
        }

        <!-- Plan de Tratamiento -->
        <div class="medical-card treatment-section">
          <div class="card-header-medical">
            <div class="header-icon-wrapper treatment-icon">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
              </svg>
            </div>
            <h2>Plan de Tratamiento</h2>
          </div>
          <div class="card-content">
            <div class="treatment-content">
              <div class="treatment-text">
                <p>{{ history.treatment }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Medicamentos Prescritos -->
        @if (history.prescriptions) {
          <div class="medical-card prescriptions-section">
            <div class="card-header-medical">
              <div class="header-icon-wrapper prescription-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M21 5h-2.64l1.14-3.14L17.15 1l-1.46 4H3v2l2 6-2 6v2h18v-2l-2-6 2-6V5zm-5 9h-3v3h-2v-3H8v-2h3V9h2v3h3v2z"/>
                </svg>
              </div>
              <h2>Medicamentos Prescritos</h2>
            </div>
            <div class="card-content">
              <div class="prescription-box">
                <div class="prescription-icon"></div>
                <p>{{ history.prescriptions }}</p>
              </div>
            </div>
          </div>
        }

        <!-- Notas Cl铆nicas -->
        @if (history.notes) {
          <div class="medical-card notes-section">
            <div class="card-header-medical">
              <div class="header-icon-wrapper notes-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
              </div>
              <h2>Notas Cl铆nicas</h2>
            </div>
            <div class="card-content">
              <div class="notes-content">
                <p>{{ history.notes }}</p>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Columna derecha (Sidebar) -->
      <div class="content-sidebar">
        <!-- Cita Relacionada -->
        @if (history.appointment) {
          <div class="medical-card appointment-section">
            <div class="card-header-medical">
              <div class="header-icon-wrapper appointment-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                </svg>
              </div>
              <h2>Cita Relacionada</h2>
            </div>
            <div class="card-content">
              <div class="appointment-details">
                <div class="appointment-item">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                  </svg>
                  <div>
                    <span class="detail-label">Fecha y Hora</span>
                    <span class="detail-value">{{ history.appointment.date | date:'dd/MM/yyyy' }} {{ history.appointment.time }}</span>
                  </div>
                </div>
                <div class="appointment-item">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-2 14l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>
                  </svg>
                  <div>
                    <span class="detail-label">Motivo de Consulta</span>
                    <span class="detail-value">{{ history.appointment.reason }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        }

        <!-- Informaci贸n Adicional -->
        <div class="medical-card info-section">
          <div class="card-header-medical">
            <div class="header-icon-wrapper info-icon">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
              </svg>
            </div>
            <h2>Informaci贸n</h2>
          </div>
          <div class="card-content">
            <div class="info-items">
              <div class="info-row">
                <span class="info-label">ID del Registro</span>
                <span class="info-value">#{{ history.id }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Fecha de Visita</span>
                <span class="info-value">{{ history.visit_date | date:'dd/MM/yyyy' }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Veterinario</span>
                <span class="info-value">{{ history.veterinarian?.name || 'N/A' }}</span>
              </div>
              @if (history.created_at) {
                <div class="info-row">
                  <span class="info-label">Creado el</span>
                  <span class="info-value">{{ history.created_at | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  }
</div>

<!-- Modal de confirmaci贸n de eliminaci贸n -->
<app-confirm-modal
  [isOpen]="showDeleteModal"
  [title]="'Confirmar eliminaci贸n'"
  [message]="'驴Est谩 seguro de eliminar este historial m茅dico? Esta acci贸n no se puede deshacer.'"
  [confirmText]="'Eliminar'"
  [cancelText]="'Cancelar'"
  [type]="'danger'"
  (confirm)="confirmDelete()"
  (cancel)="closeDeleteModal()">
</app-confirm-modal>
