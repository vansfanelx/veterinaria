<div class="my-appointments-page">
  <div class="container">
    <div class="page-header">
      <div>
        <h1>Mis Citas</h1>
        <p>Administra tus citas veterinarias</p>
      </div>
      <a routerLink="/appointments" class="btn-new">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
        Nueva Cita
      </a>
    </div>

    <div class="filters">
      <button 
        class="filter-btn"
        [class.active]="selectedFilter === 'all'"
        (click)="setFilter('all')"
      >
        Todas
      </button>
      <button 
        class="filter-btn"
        [class.active]="selectedFilter === 'upcoming'"
        (click)="setFilter('upcoming')"
      >
        Próximas
      </button>
      <button 
        class="filter-btn"
        [class.active]="selectedFilter === 'past'"
        (click)="setFilter('past')"
      >
        Pasadas
      </button>
    </div>

    @if (isLoading) {
      <div class="loading">
        <div class="spinner"></div>
        <p>Cargando citas...</p>
      </div>
    } @else if (filteredAppointments.length === 0) {
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <h2>No hay citas {{ selectedFilter === 'upcoming' ? 'próximas' : selectedFilter === 'past' ? 'pasadas' : '' }}</h2>
        <p>{{ selectedFilter === 'upcoming' ? 'Agenda tu primera cita veterinaria' : 'No tienes citas en este estado' }}</p>
        <a routerLink="/appointments" class="btn-primary">Agendar Nueva Cita</a>
      </div>
    } @else {
      <div class="appointments-list">
        @for (appointment of filteredAppointments; track appointment.id) {
          <div class="appointment-card">
            <div class="appointment-header">
              <div class="date-time">
                <div class="date">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10z"/>
                  </svg>
                  {{ appointment.date | date: 'dd/MM/yyyy' }}
                </div>
                <div class="time">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                  </svg>
                  {{ appointment.time }}
                </div>
              </div>
              <span class="status" [ngClass]="getStatusClass(appointment.status)">
                {{ getStatusLabel(appointment.status) }}
              </span>
            </div>

            <div class="appointment-body">
              <div class="info-row">
                <div class="info-item">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M4.5 9.5m-2.5 0a2.5 2.5 0 1 0 5 0a2.5 2.5 0 1 0-5 0M9 5.5m-2.5 0a2.5 2.5 0 1 0 5 0a2.5 2.5 0 1 0-5 0m6.5 4m-2.5 0a2.5 2.5 0 1 0 5 0a2.5 2.5 0 1 0-5 0"/>
                  </svg>
                  <div>
                    <span class="label">Mascota</span>
                    <strong>{{ appointment.pet_name }}</strong>
                    <span class="sublabel">({{ appointment.pet_species }})</span>
                  </div>
                </div>

                <div class="info-item">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                  <div>
                    <span class="label">Veterinario</span>
                    <strong>{{ appointment.veterinarian }}</strong>
                  </div>
                </div>
              </div>

              <div class="reason">
                <span class="label">Motivo de consulta:</span>
                <p>{{ appointment.reason }}</p>
              </div>

              @if (appointment.observations) {
                <div class="observations">
                  <span class="label">Observaciones:</span>
                  <p>{{ appointment.observations }}</p>
                </div>
              }
            </div>

            @if (canCancel(appointment)) {
              <div class="appointment-footer">
                <button class="btn-cancel" (click)="openCancelModal(appointment)">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                  </svg>
                  Cancelar Cita
                </button>
              </div>
            }
          </div>
        }
      </div>
    }
  </div>

  <!-- Modal de Confirmación de Cancelación -->
  @if (showCancelModal && appointmentToCancel) {
    <div class="modal-overlay" (click)="closeCancelModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Cancelar Cita</h2>
          <button class="btn-close" (click)="closeCancelModal()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="warning-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
            </svg>
          </div>
          <p>¿Estás seguro de que deseas cancelar esta cita?</p>
          <div class="appointment-details">
            <p><strong>Fecha:</strong> {{ appointmentToCancel.date | date: 'dd/MM/yyyy' }}</p>
            <p><strong>Hora:</strong> {{ appointmentToCancel.time }}</p>
            <p><strong>Mascota:</strong> {{ appointmentToCancel.pet_name }}</p>
          </div>
          <p class="warning-text">Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeCancelModal()">No, mantener cita</button>
          <button class="btn-danger" (click)="confirmCancel()">Sí, cancelar cita</button>
        </div>
      </div>
    </div>
  }
</div>
