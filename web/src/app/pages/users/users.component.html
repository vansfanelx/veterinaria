<div class="users-page">
  <div class="container">
    <div class="page-header">
      <div>
        <h1>Gestión de Usuarios</h1>
        <p>Administra los usuarios del sistema</p>
      </div>
      <button class="btn-primary" (click)="openCreateModal()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
        Nuevo Usuario
      </button>
    </div>

    <div class="filters-section">
      <div class="search-box">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        <input 
          type="text" 
          placeholder="Buscar por nombre, email o teléfono..." 
          (input)="onSearchChange($event)"
        >
      </div>

      <div class="filter-group">
        <label for="roleFilter">Filtrar por rol:</label>
        <select id="roleFilter" (change)="onRoleFilterChange($event)">
          <option value="all">Todos</option>
          <option value="admin">Administradores</option>
          <option value="veterinarian">Veterinarios</option>
          <option value="user">Usuarios</option>
        </select>
      </div>
    </div>

    @if (isLoading) {
      <div class="loading">
        <div class="spinner"></div>
        <p>Cargando usuarios...</p>
      </div>
    } @else if (filteredUsers().length === 0) {
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
        <h2>No se encontraron usuarios</h2>
        <p>No hay usuarios que coincidan con tu búsqueda</p>
      </div>
    } @else {
      <div class="users-table-wrapper">
        <table class="users-table">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Contacto</th>
              <th>Rol</th>
              <th>Estado</th>
              <th>Fecha de registro</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (user of filteredUsers(); track user.id) {
              <tr>
                <td>
                  <div class="user-info">
                    <div class="user-avatar">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                      </svg>
                    </div>
                    <div>
                      <p class="user-name">{{ user.name }}</p>
                      <p class="user-email">{{ user.email }}</p>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="contact-info">
                    @if (user.phone) {
                      <p>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                        </svg>
                        {{ user.phone }}
                      </p>
                    }
                    @if (user.address) {
                      <p>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        </svg>
                        {{ user.address }}
                      </p>
                    }
                  </div>
                </td>
                <td>
                  <span class="badge" [class]="getRoleBadgeClass(user.role)">
                    {{ getRoleLabel(user.role) }}
                  </span>
                </td>
                <td>
                  @if (user.email_verified_at) {
                    <span class="status-verified">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>
                      </svg>
                      Verificado
                    </span>
                  } @else {
                    <span class="status-pending">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                      </svg>
                      Pendiente
                    </span>
                  }
                </td>
                <td>{{ user.created_at | date: 'dd/MM/yyyy' }}</td>
                <td>
                  <div class="actions">
                    <button class="btn-icon btn-edit" (click)="openEditModal(user)" title="Editar">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                      </svg>
                    </button>
                    <button class="btn-icon btn-delete" (click)="openDeleteModal(user)" title="Eliminar">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>

  <!-- Modal de Crear/Editar Usuario -->
  @if (showModal) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ isEditMode ? 'Editar Usuario' : 'Nuevo Usuario' }}</h2>
          <button class="btn-close" (click)="closeModal()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        </div>
        
        <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label for="name">Nombre completo *</label>
              <input type="text" id="name" formControlName="name" placeholder="Juan Pérez">
              @if (getErrorMessage('name')) {
                <span class="error-message">{{ getErrorMessage('name') }}</span>
              }
            </div>

            <div class="form-group">
              <label for="email">Correo electrónico *</label>
              <input type="email" id="email" formControlName="email" placeholder="correo@ejemplo.com">
              @if (getErrorMessage('email')) {
                <span class="error-message">{{ getErrorMessage('email') }}</span>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="phone">Teléfono</label>
              <input type="tel" id="phone" formControlName="phone" placeholder="987654321" maxlength="9">
              @if (getErrorMessage('phone')) {
                <span class="error-message">{{ getErrorMessage('phone') }}</span>
              }
            </div>

            <div class="form-group">
              <label for="role">Rol *</label>
              <select id="role" formControlName="role">
                <option value="user">Usuario</option>
                <option value="veterinarian">Veterinario</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="address">Dirección</label>
            <input type="text" id="address" formControlName="address" placeholder="Calle Principal #123">
          </div>

          @if (!isEditMode) {
            <div class="form-row">
              <div class="form-group">
                <label for="password">Contraseña *</label>
                <input type="password" id="password" formControlName="password" placeholder="••••••••">
                @if (getErrorMessage('password')) {
                  <span class="error-message">{{ getErrorMessage('password') }}</span>
                }
              </div>

              <div class="form-group">
                <label for="password_confirmation">Confirmar contraseña *</label>
                <input type="password" id="password_confirmation" formControlName="password_confirmation" placeholder="••••••••">
              </div>
            </div>
          }

          <div class="modal-footer">
            <button type="button" class="btn-secondary" (click)="closeModal()">Cancelar</button>
            <button type="submit" class="btn-primary">
              {{ isEditMode ? 'Actualizar' : 'Crear' }} Usuario
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Modal de Confirmación de Eliminación -->
  @if (showDeleteModal && selectedUser) {
    <div class="modal-overlay" (click)="closeDeleteModal()">
      <div class="modal-content modal-small" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Confirmar Eliminación</h2>
          <button class="btn-close" (click)="closeDeleteModal()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        </div>
        
        <div class="modal-body">
          <div class="warning-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
            </svg>
          </div>
          <p>¿Estás seguro de que deseas eliminar al usuario <strong>{{ selectedUser.name }}</strong>?</p>
          <p class="warning-text">Esta acción no se puede deshacer.</p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" (click)="closeDeleteModal()">Cancelar</button>
          <button type="button" class="btn-danger" (click)="confirmDelete()">Eliminar</button>
        </div>
      </div>
    </div>
  }
</div>
